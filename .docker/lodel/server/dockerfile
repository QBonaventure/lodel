FROM alpine

ENV NGINX_VERSION nginx-1.13.7

RUN adduser -DH -u 1000 www-data

RUN apk add --update \
    git \
    g++ \
    make \
    openssl-dev \
    zlib-dev \
    pcre-dev \
    linux-pam-dev


RUN cd /tmp && \
    git clone https://github.com/nginx/nginx.git && \
    git clone https://github.com/nginx-modules/ngx_http_auth_pam_module.git

RUN cd /tmp/nginx && \
     ./auto/configure \
        --with-http_ssl_module \
        --with-http_gzip_static_module \
        --prefix=/etc/nginx \
        --http-log-path=/var/log/nginx/access.log \
        --error-log-path=/var/log/nginx/error.log \
        --sbin-path=/usr/local/sbin/nginx \
        --add-module=/tmp/ngx_http_auth_pam_module && \
    make && \
    make install

RUN echo http://dl-2.alpinelinux.org/alpine/edge/community/ >> /etc/apk/repositories && \
    apk --no-cache add shadow


RUN ln -sf /dev/stdout /var/log/nginx/access.log && \
    ln -sf /dev/stderr /var/log/nginx/error.log


CMD ["nginx", "-g", "daemon off;"]

#EXPOSE 80 443

